# Implementation Log: Replace Consumer SimplePool with NostrService

## Task Overview
Refactoring `useNip90ConsumerChat.ts` to use NostrService instead of SimplePool for subscriptions, following instructions in `1417-instructions.md`.

**Root Cause:** Consumer uses broken SimplePool for subscriptions while NostrService (used for publishing and by provider) works perfectly.

## Implementation Plan
1. Import NostrService and remove SimplePool dependency  
2. Replace SimplePool subscriptions with NostrService subscriptions
3. Update cleanup logic
4. Ensure publishing consistency
5. Test the changes

## Step 1: Update Imports and Remove SimplePool ✅

- Removed SimplePool import
- Added NostrService import  
- Removed poolRef.current SimplePool initialization
- Updated cleanup logic to use unsub() method instead of close()

## Step 2: Remove SimplePool Check in sendMessage ✅

Removed poolRef.current validation in sendMessage function.

## Step 3: Replace Publishing with NostrService ✅

Replaced:
```typescript
const publishPromises = poolRef.current.publish(DEFAULT_RELAYS, signedEvent);
await Promise.any(publishPromises);
```

With:
```typescript
const nostrService = Context.get(currentRuntime.context, NostrService);
const publishEffect = nostrService.publishEvent(signedEvent, DEFAULT_RELAYS);
await Effect.runPromise(publishEffect.pipe(Effect.provide(currentRuntime)));
```

## Step 4: Replace Subscriptions with NostrService ✅

Replaced SimplePool subscription calls with NostrService pattern:
```typescript
const subscribeEffect = Effect.gen(function* () {
  const resultSub = yield* nostrService.subscribeToEvents([filters[0]], handleEvent, DEFAULT_RELAYS, () => handleEose("result"));
  const feedbackSub = yield* nostrService.subscribeToEvents([filters[1]], handleEvent, DEFAULT_RELAYS, () => handleEose("feedback"));
  return { resultSub, feedbackSub };
});
```

## Step 5: Update Cleanup Logic ✅

Updated all subscription cleanup to use `unsub()` instead of `close()`:
```typescript
if (resultSub && typeof resultSub.unsub === 'function') resultSub.unsub();
```

## Testing Implementation

Running tests to verify the refactor works...