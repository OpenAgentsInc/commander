# CORS Fix for Ollama `traceparent` Header (with TypeScript Fix)

## Problem
After updating the Content Security Policy to allow connections to the Ollama API server running at `http://localhost:11434`, we encountered a CORS preflight error:

```
Access to XMLHttpRequest at 'http://localhost:11434/' from origin 'http://localhost:5173' has been blocked by CORS policy: Request header field traceparent is not allowed by Access-Control-Allow-Headers in preflight response.
```

This indicated that the `traceparent` header, automatically added by the `@effect/platform/HttpClient` for distributed tracing, was not allowed by the Ollama server's CORS policy.

## Analysis
The issue is occurring because:
1. Our application (running on `http://localhost:5173`) is trying to send a request to the Ollama server (`http://localhost:11434`).
2. The Effect HTTP client automatically adds a `traceparent` header for distributed tracing.
3. When the browser sends a preflight OPTIONS request to check if this non-standard header is allowed, the Ollama server doesn't include `traceparent` in its `Access-Control-Allow-Headers` response.
4. As a result, the browser blocks the actual request due to CORS policy.

## Solution
Since we can't modify the Ollama server's CORS configuration, we need to prevent our client from sending the `traceparent` header. The `@effect/platform/HttpClient` provides a way to disable tracer propagation.

I implemented the following changes in `src/services/ollama/OllamaServiceImpl.ts`:

1. In the `OllamaServiceLive` layer definition, created a modified HTTP client with tracer propagation disabled:

```typescript
// Import the module for utility functions
import * as HttpClientModule from "@effect/platform/HttpClient";

// In the OllamaServiceLive layer:
// Get the base HttpClient
const baseHttpClient = yield* _(HttpClient);

// Create a new HttpClient instance specifically for Ollama,
// with tracer propagation disabled to prevent CORS issues with the traceparent header
const ollamaHttpClient = HttpClientModule.withTracerPropagation(baseHttpClient, false);

// Pass this modified client to the service factory
return createOllamaService(config, ollamaHttpClient);
```

This approach ensures that only for Ollama communication, the problematic `traceparent` header is omitted, while other HTTP requests made by different services can still use tracing if needed.

### TypeScript Fix

Initially, I was getting a TypeScript error:
```
Property 'withTracerPropagation' does not exist on type 'Tag<HttpClient, HttpClient>'
```

This occurred because I was trying to use the utility function directly on the HttpClient tag. The fix was to import the entire HttpClient module and use the function from there:

```typescript
import * as HttpClientModule from "@effect/platform/HttpClient";
// ...
const ollamaHttpClient = HttpClientModule.withTracerPropagation(baseHttpClient, false);
```

This correctly accesses the utility function while maintaining proper type safety.

## Verification
To verify the changes:

1. Restart the development server with `pnpm start`
2. Confirm that the application can now connect to the Ollama server without CORS errors
3. The HTTP requests to Ollama should no longer include the `traceparent` header, which will prevent the CORS preflight rejection

This change avoids the need to modify the server's CORS configuration while allowing our application to successfully communicate with the Ollama API.