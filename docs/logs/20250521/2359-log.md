# Task 2359: Fix OllamaAgentLanguageModelLive.test.ts

## Initial Analysis

I'm reviewing the instructions to fix the OllamaAgentLanguageModelLive.test.ts test failures. The main issue is the TypeError: "Cannot read properties of undefined (reading 'pipe')" which occurs when trying to use methods on the provider object that are either undefined or don't have a pipe method.

The instructions recommend:
1. Modifying the SUT (OllamaAgentLanguageModelLive.ts) to use the real OpenAiLanguageModel from @effect/ai-openai instead of our local mock
2. Ensuring the test file mocks are correctly structured for the real library

## Phase 1: Modifying the SUT

First, I'll update OllamaAgentLanguageModelLive.ts:
1. Remove the local mock of OpenAiLanguageModel
2. Ensure correct import for OpenAiCompletions
3. Use the real OpenAiCompletions.OpenAiLanguageModel.model and properly resolve the provider

Changes implemented:
- Removed the entire local mock `OpenAiLanguageModel` object
- Added import for `OpenAiCompletions` from `@effect/ai-openai`
- Added imports for required types from `@effect/ai/AiLanguageModel` and `@effect/ai/AiModel`
- Used `OpenAiCompletions.OpenAiLanguageModel.model` directly
- Implemented proper two-step resolution with proper types:
  1. Get the AiModel definition from the library
  2. Provide the client service
  3. Execute to get the AiModel instance
  4. Execute the AiModel to get the Provider
- Simplified error mapping code to expect errors from the real library

## Phase 2: Ensuring Test File Mocks Are Correct

Updated OllamaAgentLanguageModelLive.test.ts to ensure the mocks are compatible with the real library:
1. Added proper type imports:
   - Added `StreamCompletionRequest` from `@effect/ai-openai/Generated`
   - Added `ParseError` from `@effect/schema/ParseResult`
2. Updated mock implementations to return Effect/Stream with correct error channel types:
   - Updated `mockCreateChatCompletion` to return `Effect<..., HttpClientError.HttpClientError | ParseError>`
   - Updated `mockStream` to return `Stream<..., HttpClientError.HttpClientError | ParseError>`
3. Ensured `MockHttpClient` is provided in all test layers by adding explicit comments marking it as CRUCIAL
4. Updated error mapping test to use the correct error types from HttpClientError

## Running Tests

Let me run the tests to verify that the changes fixed the issues: