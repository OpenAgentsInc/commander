# Implementation Log: Fixing Infinite Loop in WalletSetupPage

## Task Overview
The task is to fix an infinite loop issue in the WalletSetupPage component that's causing a "Maximum update depth exceeded" error. The issue is related to how the component is using Zustand store hooks.

## Investigation
I examined the WalletSetupPage.tsx file and identified the problematic Zustand store hook usage. The component is creating a new object on every render when selecting from the store, which is triggering infinite re-renders.

The key issue is at line 13 where the component is using `useWalletStore` with a selector function that returns a new object reference on each call:

```typescript
const { generateNewWallet, isLoading, error, clearError } = useWalletStore(
  (state) => ({
    generateNewWallet: state.generateNewWallet,
    isLoading: state.isLoading,
    error: state.error,
    clearError: state.clearError,
  })
);
```

Similar issues exist in other components that use Zustand with object selectors.

## Solution Implementation

I applied the following fixes:

1. **Added shallow equality checking to WalletSetupPage.tsx**:
   - Added the `shallow` import from 'zustand/shallow'
   - Applied shallow equality check to both `useWalletStore` and `usePaneStore` hooks

```typescript
import { shallow } from 'zustand/shallow';

// ...

const { generateNewWallet, isLoading, error, clearError } = useWalletStore(
  (state) => ({
    generateNewWallet: state.generateNewWallet,
    isLoading: state.isLoading,
    error: state.error,
    clearError: state.clearError,
  }),
  shallow // Add shallow equality check to prevent unnecessary re-renders
);
```

2. **Applied the same fix to related components**:
   - SeedPhraseBackupPage.tsx
   - RestoreWalletPage.tsx
   - App.tsx
   - PaneManager.tsx

3. **Refactored App.tsx** to use proper object destructuring with shallow comparison:
   ```typescript
   const { panes, openWalletSetupPane } = usePaneStore(
     (state) => ({
       panes: state.panes,
       openWalletSetupPane: state.openWalletSetupPane
     }),
     shallow
   );
   ```

4. **Refactored PaneManager.tsx** with the same pattern:
   ```typescript
   const { panes, activePaneId } = usePaneStore(
     (state) => ({
       panes: state.panes,
       activePaneId: state.activePaneId
     }),
     shallow
   );
   ```

## Explanation

The root cause of the infinite loop was that when using Zustand's store hooks with object selectors, the selector function creates a new object reference on every render. React's `useSyncExternalStore` hook (used internally by Zustand) then sees this new reference as a state change, causing another re-render, and this cycle repeats infinitely.

By adding the `shallow` equality check as the second parameter to the Zustand hooks, we're telling Zustand to compare the previous and new objects shallowly, and only trigger a re-render if any of the actual property values have changed, not just when the object reference changes.

This prevents the infinite loop by stopping unnecessary re-renders when the selected state hasn't actually changed in value, just in reference.
