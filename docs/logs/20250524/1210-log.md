# Model Selection Fix Implementation
## May 24, 2025 - 12:10

## Overview
Fixing the critical issue where DVM ignores requested model parameter and uses local config instead. Users request `devstral` but get `gemma3:1b` responses.

## Analysis from 1207-analysis.md
- Consumer correctly sends `devstral` model requests via NIP-90
- DVM receives requests but uses local config `gemma3:1b` instead
- Bug is in model parameter extraction/usage in DVM job processing

## Implementation Progress

### ‚úÖ Root Cause Identified
Found the exact bug in `Kind5050DVMServiceImpl.ts`:

**Problem**: Two different code paths for job processing:
1. **Old path** (line ~1031): ‚úÖ Correctly includes `model: aiModel` in generateOptions
2. **New optimistic path** (line ~1442): ‚ùå **Missing model parameter** in generateOptions

**Evidence**:
- Line 1434: `model: paramsMap.get("model") || textGenConfig.model,` - correctly parsed
- Line 1442-1446: `generateOptions` object only has `prompt`, `maxTokens`, `temperature` - **missing model**
- Line 1031: Old path correctly includes `model: aiModel`

The optimistic processing uses local config model instead of requested model!

### ‚úÖ Fixed Model Parameter Missing
Applied fix in `Kind5050DVMServiceImpl.ts` line ~1444:

**Before**:
```typescript
const generateOptions = {
  prompt: pendingJob.prompt,
  maxTokens: requestParams.max_tokens,
  temperature: requestParams.temperature,
}; // Missing model parameter!
```

**After**:
```typescript
const generateOptions = {
  prompt: pendingJob.prompt,
  model: requestParams.model, // FIX: Add missing model parameter
  maxTokens: requestParams.max_tokens,
  temperature: requestParams.temperature,
};
```

### ‚úÖ Added Model Selection Telemetry
Added logging to track which model is selected:
- Logs requested model vs default model
- Will help verify the fix is working
- Category: `dvm:job`, Action: `ai_model_selected`

## üéâ Fix Implementation Complete

### Summary of Changes:
1. **Root Cause**: Optimistic processing path was missing `model` parameter in `generateOptions`
2. **Fix Applied**: Added `model: requestParams.model` to line 1444
3. **Telemetry Added**: Model selection logging for debugging

### Expected Behavior:
- Consumer requests `devstral` model via NIP-90
- DVM correctly extracts `model` parameter from request
- DVM passes `model` to AI service in `generateOptions`
- User receives response from `devstral` instead of `gemma3:1b`

### Next Steps:
- Test with real NIP-90 requests
- Verify telemetry shows correct model selection
- Confirm users receive responses from requested model (not local config)
